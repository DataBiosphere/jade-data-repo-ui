name: e2e
env:
  # This must be defined for the bash redirection
  GOOGLE_APPLICATION_CREDENTIALS: 'jade-dev-account.json'
  # This must be defined for the bash redirection
  GOOGLE_SA_CERT: 'jade-dev-account.pem'
on:
  workflow_dispatch: {}
  pull_request:
    branches:
      - develop
  schedule:
    - cron: '0 4 * * *' # run at 4 AM UTC, 12PM EST.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
jobs:
  e2e_test:
    name: Cypress End-to-end Tests
    timeout-minutes: 180
    strategy:
      matrix:
        node-version: [20.x]
    if: "!contains( github.event.pull_request.labels.*.name, 'skip-ci')"
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: initialize npm
        env:
          DEV_PROJECT: broad-jade-dev
          DISABLE_ESLINT_PLUGIN: true
        run: |
          GCR_TAG=$(git rev-parse --short HEAD)
          echo "GCR_TAG=$(echo ${GCR_TAG})" >> $GITHUB_ENV
          npm ci
      - name: set npm env
        run: |
          eval $(cat env_vars)
          echo "HOST=$(echo ${localhost})" >> $GITHUB_ENV
          HOST=localhost
          echo "HOST=$(echo ${HOST})" >> $GITHUB_ENV
      - name: check npm start
        env:
          DISABLE_ESLINT_PLUGIN: true
        run: |
          npm start & timeout 600 bash -c "until nc -z localhost 3000; do sleep 5; done"
      - name: set cypresss env
        run: |
          eval $(cat env_vars)
          echo "CYPRESS_BASE_URL=$(echo ${IT_JADE_API_URL})" >> $GITHUB_ENV
          CYPRESS_GOOGLE_TOKEN=$(gcloud auth print-access-token)
          echo ::add-mask::${CYPRESS_GOOGLE_TOKEN}
          echo "CYPRESS_GOOGLE_TOKEN=$(echo ${CYPRESS_GOOGLE_TOKEN})" >> $GITHUB_ENV
      - name: Cypress run
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          DISABLE_ESLINT_PLUGIN: true
        run: |
          npx cypress run --record
#  report-workflow:
#    uses: broadinstitute/sherlock/.github/workflows/client-report-workflow.yaml@main
#    if: ${{ github.ref == 'refs/heads/develop' }}
#    with:
#      relates-to-chart-releases: 'datarepo-dev'
#      notify-slack-channels-upon-workflow-failure: ${{ vars.SLACK_NOTIFICATION_CHANNELS }}
#      notify-slack-channels-upon-workflow-retry: ${{ vars.SLACK_NOTIFICATION_CHANNELS }}
#      notify-slack-custom-icon: ':terra-horse:'
#    permissions:
#      id-token: write
