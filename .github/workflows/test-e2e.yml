name: e2e
on: push
jobs:
  build:
    if: "!contains( github.event.pull_request.labels.*.name, 'skip-ci')"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [12.x]

    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}
      - name: Check out the repository
        uses: actions/checkout@v1
      - name: "Whitelist Runner IP"
        uses: broadinstitute/datarepo-actions@my-ui-steps
        with:
          actions_subcommand: "gcp_whitelist"
          role_id: ${{ secrets.ROLE_ID }}
          secret_id: ${{ secrets.SECRET_ID }}
      - name: "Check for an availble namespace to deploy API to and set state lock"
        uses: broadinstitute/datarepo-actions@my-ui-steps
        with:
          actions_subcommand: "k8_checknamespace"
          k8_namespaces: "integration-6,integration-7"
      - name: Build new ui container
        env:
          DEV_PROJECT: broad-jade-dev
        run: |
          GCR_TAG=$(git rev-parse --short HEAD)
          echo "::set-env name=GCR_TAG::${GCR_TAG}"
          npm ci
          npm run-script build
      # Build the Docker image
      - name: Build
        run: |
          docker build -t gcr.io/broad-jade-dev/jade-data-repo-ui:${GCR_TAG} .
      # Push the Docker image to Google Container Registry
      - name: Publish
        run: |
          docker push gcr.io/broad-jade-dev/jade-data-repo-ui:${GCR_TAG}
      - name: "Deploy to cluster with Helm"
        uses: broadinstitute/datarepo-actions@my-ui-steps
        with:
          actions_subcommand: "helmdeploy"
          helm_secret_chart_version: "0.0.4"
          helm_datarepo_chart_version: "0.0.8"
      - name: wait for status checks
        run: |
          kubectl get deployments -n integration integration-jade-datarepo-ui -o json | jq '.status.unavailableReplicas'
      - name: set cypresss env
        run: |
          CYPRESS_GOOGLE_TOKEN=$(gcloud auth print-access-token)
          echo ::add-mask::${CYPRESS_GOOGLE_TOKEN}
          echo ::set-env name=CYPRESS_GOOGLE_TOKEN::${CYPRESS_GOOGLE_TOKEN}
      - name: Cypress run
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
        run: |
          npx cypress run --record
      - name: "Clean state lock from used Namespace on API deploy"
        if: always()
        uses: broadinstitute/datarepo-actions@my-ui-steps
        with:
          actions_subcommand: "k8_checknamespace_clean"
      - name: "Clean whitelisted Runner IP"
        if: always()
        uses: broadinstitute/datarepo-actions@my-ui-steps
        with:
          actions_subcommand: "gcp_whitelist_clean"
